<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        /* Estilos básicos para as telas */
        #chatScreen, #connectScreen {
            display: none; /* Oculta as telas inicialmente */
        }
        #userList {
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        #userList div {
            cursor: pointer;
            padding: 5px;
        }
        #userList div:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>

<!-- Tela de Conexão -->
<div id="connectScreen">
    <h2>Conectar</h2>
    <input type="text" id="usernameInput" placeholder="Digite seu nome" />
    <button id="connectButton">Conectar</button>
</div>

<!-- Tela de Chat -->
<div id="chatScreen">
    <h2>Chat</h2>
    <div id="userList"></div>
    <div id="chatMessages"></div>
    <input type="text" id="messageInput" placeholder="Digite sua mensagem" />
    <button id="sendMessageButton">Enviar</button>
</div>

<script>
    let socket;
    const connectScreen = document.getElementById('connectScreen');
    const chatScreen = document.getElementById('chatScreen');
    const usernameInput = document.getElementById('usernameInput');
    const connectButton = document.getElementById('connectButton');
    const userList = document.getElementById('userList');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageButton = document.getElementById('sendMessageButton');
    let currentChatReceiver = ''; // Para armazenar o usuário selecionado para chat privado

    // Exibe a tela de conexão ao carregar
    connectScreen.style.display = 'block';

    // Conecta ao WebSocket
    connectButton.addEventListener('click', () => {
        const username = usernameInput.value;

        if (username.trim() === '') {
            alert('Por favor, insira um nome.');
            return;
        }

        // Conecta ao WebSocket
        socket = new WebSocket(`ws://localhost:8080/chat?username=${username}`);

        socket.onopen = () => {
            connectScreen.style.display = 'none'; // Oculta a tela de conexão
            chatScreen.style.display = 'block'; // Exibe a tela de chat
        };

        // Recebe mensagens
        socket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === "userList") {
                // Atualiza a lista de usuários conectados
                updateUserList(message.content);
            } else {
                chatMessages.innerHTML += `<div><strong>${message.sender}:</strong> ${message.content}</div>`;
            }
        };

        sendMessageButton.addEventListener('click', () => {
            const messageContent = messageInput.value;
            const message = {
                type: currentChatReceiver ? "queue" : "topic", // Usa "queue" para chats privados
                content: messageContent,
                sender: username,
                receiver: currentChatReceiver // Define o receptor para o chat privado
            };

            socket.send(JSON.stringify(message));
            messageInput.value = ''; // Limpa o campo de mensagem
        });
    });

    // Função para atualizar a lista de usuários
    function updateUserList(users) {
        userList.innerHTML = ''; // Limpa a lista atual
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.innerText = user;
            userDiv.addEventListener('click', () => {
                currentChatReceiver = user; // Armazena o usuário selecionado
                chatMessages.innerHTML += `<div><strong>Iniciando chat privado com ${user}</strong></div>`;
            });
            userList.appendChild(userDiv);
        });
    }
</script>

</body>
</html>
